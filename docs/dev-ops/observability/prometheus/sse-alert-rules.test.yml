rule_files:
  - sse-alert-rules.yml

evaluation_interval: 1m

tests:
  - interval: 1m
    input_series:
      - series: 'agent_sse_push_attempt_total{env="prod"}'
        values: '0+100x30'
      - series: 'agent_sse_push_fail_total{env="prod"}'
        values: '0+1x30'
      - series: 'agent_sse_replay_batch_total{env="prod"}'
        values: '0+100x30'
      - series: 'agent_sse_replay_hit_total{env="prod"}'
        values: '0+95x30'
      - series: 'agent_sse_replay_duration_seconds_sum{env="prod"}'
        values: '0+30x30'
      - series: 'agent_sse_replay_duration_seconds_count{env="prod"}'
        values: '0+100x30'
    alert_rule_test:
      - eval_time: 20m
        alertname: SsePushFailRatioCriticalProd
        exp_alerts: []
      - eval_time: 20m
        alertname: SseReplayHitRatioLowCriticalProd
        exp_alerts: []
      - eval_time: 20m
        alertname: SseReplayAvgDurationHighCriticalProd
        exp_alerts: []

  - interval: 1m
    input_series:
      - series: 'agent_sse_push_attempt_total{env="prod"}'
        values: '0+100x30'
      - series: 'agent_sse_push_fail_total{env="prod"}'
        values: '0+6x30'
    alert_rule_test:
      - eval_time: 20m
        alertname: SsePushFailRatioCriticalProd
        exp_alerts:
          - exp_labels:
              alertname: SsePushFailRatioCriticalProd
              service: agent-app
              module: sse
              severity: critical
              env: prod

  - interval: 1m
    input_series:
      - series: 'agent_sse_replay_batch_total{env="prod"}'
        values: '0+100x30'
      - series: 'agent_sse_replay_hit_total{env="prod"}'
        values: '0+5x30'
    alert_rule_test:
      - eval_time: 20m
        alertname: SseReplayHitRatioLowCriticalProd
        exp_alerts:
          - exp_labels:
              alertname: SseReplayHitRatioLowCriticalProd
              service: agent-app
              module: sse
              severity: critical
              env: prod

  - interval: 1m
    input_series:
      - series: 'agent_sse_replay_duration_seconds_sum{env="prod"}'
        values: '0+240x30'
      - series: 'agent_sse_replay_duration_seconds_count{env="prod"}'
        values: '0+100x30'
    alert_rule_test:
      - eval_time: 20m
        alertname: SseReplayAvgDurationHighCriticalProd
        exp_alerts:
          - exp_labels:
              alertname: SseReplayAvgDurationHighCriticalProd
              service: agent-app
              module: sse
              severity: critical
              env: prod

  - interval: 1m
    input_series:
      - series: 'agent_sse_push_attempt_total{env="staging"}'
        values: '0+100x30'
      - series: 'agent_sse_push_fail_total{env="staging"}'
        values: '0+7x30'
      - series: 'agent_sse_replay_batch_total{env="staging"}'
        values: '0+100x30'
      - series: 'agent_sse_replay_hit_total{env="staging"}'
        values: '0+10x30'
      - series: 'agent_sse_replay_duration_seconds_sum{env="staging"}'
        values: '0+200x30'
      - series: 'agent_sse_replay_duration_seconds_count{env="staging"}'
        values: '0+100x30'
    alert_rule_test:
      - eval_time: 25m
        alertname: SsePushFailRatioWarningStaging
        exp_alerts:
          - exp_labels:
              alertname: SsePushFailRatioWarningStaging
              service: agent-app
              module: sse
              severity: warning
              env: staging
      - eval_time: 25m
        alertname: SseReplayHitRatioLowWarningStaging
        exp_alerts:
          - exp_labels:
              alertname: SseReplayHitRatioLowWarningStaging
              service: agent-app
              module: sse
              severity: warning
              env: staging
      - eval_time: 25m
        alertname: SseReplayAvgDurationHighWarningStaging
        exp_alerts:
          - exp_labels:
              alertname: SseReplayAvgDurationHighWarningStaging
              service: agent-app
              module: sse
              severity: warning
              env: staging
