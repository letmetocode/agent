spring:
  config:
    name: agent-app
  profiles:
    active: dev

# 调度器隔离配置，避免长耗时执行阻塞状态推进守护任务
scheduling:
  task-executor:
    pool-size: 1
    thread-name-prefix: task-executor-scheduler-
    await-termination-seconds: 30
  daemon:
    pool-size: 2
    thread-name-prefix: daemon-scheduler-
    await-termination-seconds: 30

executor:
  claim:
    # 每轮最多 claim 数量，最终仍受 worker 可用槽位限制
    max-per-tick: 100
    # true: READY-like 优先后再 REFINING；false: 先 REFINING 后 READY-like
    ready-first: true
    # 每轮最多给 REFINING 的配额比例（0~1）
    refining-max-ratio: 0.3
    # 每轮给 REFINING 的最小保障
    refining-min-per-tick: 1
  execution:
    # 单次 TaskClient 调用超时时间（毫秒）
    timeout-ms: 120000
    # 调用超时后的额外重试次数（1 = 最多尝试 2 次）
    timeout-retry-max: 1
  worker:
    core-size: 8
    max-size: 8
    queue-capacity: 0
    keep-alive-seconds: 60
    rejection-policy: AbortPolicy
    thread-name-prefix: task-exec-worker-
  agent:
    # 任务未显式配置 agentKey/agentId 时的兜底 key 列表（按顺序尝试）
    fallback-worker-keys: worker,assistant,java_coder,default
    fallback-critic-keys: critic,assistant,java_coder,default
    # 兜底“首个激活 Agent”查询缓存 TTL
    default-cache-ttl-ms: 30000
  observability:
    audit-log-enabled: true
    audit-success-log-enabled: false

agent:
  tool:
    config:
      # 兼容回滚开关：true 时保留 OpenAiChatOptions 工具字段写入
      legacy-options-write: false
    query:
      # 批量查询分片大小，避免 IN 过大
      batch-size: 500
      # 工具查询慢日志阈值
      slow-threshold-ms: 200

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always

sse:
  heartbeat-interval-ms: 10000
  replay-interval-ms: 3000
  replay:
    # 每次回放 sweep 的单批次查询上限
    batch-size: 200
    # 每次 sweep 对单订阅者最多回放批次数，默认 1（避免单连接拖垮系统）
    max-batches-per-sweep: 1

event:
  notify:
    channel: plan_task_events_channel
  publisher:
    instance-id: ${PUBLISHER_INSTANCE_ID:}

cors:
  allowed-origin-patterns: http://localhost:5173,http://127.0.0.1:5173

app:
  share:
    # 任务分享链接生成时使用的外部访问地址（前端域名）
    base-url: http://127.0.0.1:8091
    # 令牌哈希盐（生产环境务必通过环境变量覆盖）
    token-salt: ${APP_SHARE_TOKEN_SALT:agent-share-salt}
    # 分享链接最大有效期（小时）
    max-ttl-hours: ${APP_SHARE_MAX_TTL_HOURS:168}

observability:
  http-log:
    # 统一 HTTP 入口日志开关
    enabled: true
    # 记录路径（Ant 风格）
    include-path-patterns: /api/**
    # 排除路径（SSE 流仅记录建连，不做逐条事件日志）
    exclude-path-patterns: /actuator/**,/api/v3/chat/sessions/*/stream
    # 默认不记录全量请求体，仅保留白名单字段摘要
    log-request-body: false
    request-body-whitelist: message,sessionId,turnId,planId
    # 脱敏字段（大小写不敏感）
    mask-fields: apiKey,authorization,password,token,secret
    # 慢请求阈值（ms）
    slow-request-threshold-ms: 1000
    # 采样率（生产可按需下调）
    sample-rate: 1.0
    # 请求体摘要最大长度
    max-body-length: 1024
