<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.getoffer.infrastructure.dao.TaskExecutionDao">

    <resultMap id="BaseResultMap" type="com.getoffer.infrastructure.dao.po.TaskExecutionPO">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="task_id" property="taskId" jdbcType="BIGINT"/>
        <result column="attempt_number" property="attemptNumber" jdbcType="INTEGER"/>
        <result column="prompt_snapshot" property="promptSnapshot" jdbcType="VARCHAR"/>
        <result column="llm_response_raw" property="llmResponseRaw" jdbcType="VARCHAR"/>
        <result column="model_name" property="modelName" jdbcType="VARCHAR"/>
        <result column="token_usage" property="tokenUsage" jdbcType="VARCHAR"/>
        <result column="execution_time_ms" property="executionTimeMs" jdbcType="BIGINT"/>
        <result column="is_valid" property="isValid" jdbcType="BOOLEAN"/>
        <result column="validation_feedback" property="validationFeedback" jdbcType="VARCHAR"/>
        <result column="error_message" property="errorMessage" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, task_id, attempt_number, prompt_snapshot, llm_response_raw,
        model_name, token_usage, execution_time_ms, is_valid,
        validation_feedback, error_message, created_at
    </sql>

    <insert id="insert" parameterType="com.getoffer.infrastructure.dao.po.TaskExecutionPO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO task_executions (
            task_id, attempt_number, prompt_snapshot, llm_response_raw,
            model_name, token_usage, execution_time_ms, is_valid,
            validation_feedback, error_message, created_at
        ) VALUES (
            #{taskId}, #{attemptNumber}, #{promptSnapshot}, #{llmResponseRaw},
            #{modelName}, #{tokenUsage}::jsonb, #{executionTimeMs}, #{isValid},
            #{validationFeedback}, #{errorMessage}, CURRENT_TIMESTAMP
        )
    </insert>

    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM task_executions WHERE id = #{id}
    </delete>

    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM task_executions
        WHERE id = #{id}
    </select>

    <select id="selectByTaskId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM task_executions
        WHERE task_id = #{taskId}
        ORDER BY attempt_number ASC
    </select>

    <select id="selectByTaskIdOrderByAttempt" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM task_executions
        WHERE task_id = #{taskId}
        ORDER BY attempt_number DESC
    </select>

    <select id="selectByTaskIdAndAttempt" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM task_executions
        WHERE task_id = #{taskId} AND attempt_number = #{attemptNumber}
    </select>

    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM task_executions
        ORDER BY created_at DESC
    </select>

    <select id="getMaxAttemptNumber" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(attempt_number), 0)
        FROM task_executions
        WHERE task_id = #{taskId}
    </select>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO task_executions (
            task_id, attempt_number, prompt_snapshot, llm_response_raw,
            model_name, token_usage, execution_time_ms, is_valid,
            validation_feedback, error_message, created_at
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.taskId}, #{item.attemptNumber}, #{item.promptSnapshot}, #{item.llmResponseRaw},
             #{item.modelName}, #{item.tokenUsage}::jsonb, #{item.executionTimeMs}, #{item.isValid},
             #{item.validationFeedback}, #{item.errorMessage}, CURRENT_TIMESTAMP)
        </foreach>
    </insert>

</mapper>
