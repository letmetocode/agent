<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.getoffer.infrastructure.dao.AgentPlanDao">

    <resultMap id="BaseResultMap" type="com.getoffer.infrastructure.dao.po.AgentPlanPO">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="session_id" property="sessionId" jdbcType="BIGINT"/>
        <result column="route_decision_id" property="routeDecisionId" jdbcType="BIGINT"/>
        <result column="workflow_definition_id" property="workflowDefinitionId" jdbcType="BIGINT"/>
        <result column="workflow_draft_id" property="workflowDraftId" jdbcType="BIGINT"/>
        <result column="plan_goal" property="planGoal" jdbcType="VARCHAR"/>
        <result column="execution_graph" property="executionGraph" jdbcType="VARCHAR"/>
        <result column="definition_snapshot" property="definitionSnapshot" jdbcType="VARCHAR"/>
        <result column="global_context" property="globalContext" jdbcType="VARCHAR"/>
        <result column="status" property="status" javaType="com.getoffer.types.enums.PlanStatusEnum" jdbcType="OTHER"/>
        <result column="priority" property="priority" jdbcType="INTEGER"/>
        <result column="error_summary" property="errorSummary" jdbcType="VARCHAR"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, session_id, route_decision_id, workflow_definition_id, workflow_draft_id,
        plan_goal, execution_graph, definition_snapshot, global_context,
        status, priority, error_summary, version, created_at, updated_at
    </sql>

    <insert id="insert" parameterType="com.getoffer.infrastructure.dao.po.AgentPlanPO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO agent_plans (
            session_id, route_decision_id, workflow_definition_id, workflow_draft_id,
            plan_goal, execution_graph, definition_snapshot, global_context,
            status, priority, error_summary, version, created_at, updated_at
        ) VALUES (
            #{sessionId}, #{routeDecisionId}, #{workflowDefinitionId}, #{workflowDraftId},
            #{planGoal}, #{executionGraph}::jsonb, #{definitionSnapshot}::jsonb,
            #{globalContext}::jsonb, #{status}::plan_status_enum, #{priority},
            #{errorSummary}, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    </insert>

    <update id="updateWithVersion" parameterType="com.getoffer.infrastructure.dao.po.AgentPlanPO">
        UPDATE agent_plans SET
            session_id = #{sessionId},
            route_decision_id = #{routeDecisionId},
            workflow_definition_id = #{workflowDefinitionId},
            workflow_draft_id = #{workflowDraftId},
            plan_goal = #{planGoal},
            execution_graph = #{executionGraph}::jsonb,
            definition_snapshot = #{definitionSnapshot}::jsonb,
            global_context = #{globalContext}::jsonb,
            status = #{status}::plan_status_enum,
            priority = #{priority},
            error_summary = #{errorSummary},
            version = version + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id} AND version = #{version}
    </update>

    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM agent_plans WHERE id = #{id}
    </delete>

    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        WHERE id = #{id}
    </select>

    <select id="selectBySessionId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        WHERE session_id = #{sessionId}
        ORDER BY priority DESC, created_at DESC
    </select>

    <select id="selectByStatus" parameterType="com.getoffer.types.enums.PlanStatusEnum" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        WHERE status = #{status}::plan_status_enum
        ORDER BY priority DESC, created_at ASC
    </select>

    <select id="selectByStatusAndPriority" parameterType="com.getoffer.types.enums.PlanStatusEnum" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        WHERE status = #{status}::plan_status_enum
        ORDER BY priority DESC, created_at ASC
        LIMIT 100
    </select>

    <select id="selectByStatusPaged" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        WHERE status = #{status}::plan_status_enum
        ORDER BY priority DESC, created_at ASC
        OFFSET #{offset}
        LIMIT #{limit}
    </select>

    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        ORDER BY created_at DESC
    </select>

    <select id="selectByWorkflowDefinitionId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM agent_plans
        WHERE workflow_definition_id = #{workflowDefinitionId}
        ORDER BY created_at DESC
    </select>

</mapper>
